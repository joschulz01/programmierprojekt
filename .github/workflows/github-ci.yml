name: CI/CD for Angular Project

# AusfÃ¼hrung bei Pull-Request in dem Main-Branch
on:
  pull_request:
    branches-ignore:
      - 'snyk-upgrade-*'

defaults:
  run:
    shell: bash
    working-directory: ./programmierprojekt

jobs:
  lint:
    name: Lint der Angular App
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [22.x]

    steps:
      # Checkout Repository
      - name: Checkout Repository
        uses: actions/checkout@v3

      # Set up Node.js environment
      - name: Set up Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}

      # Install Dependencies
      - name: Install Dependencies
        run: npm install -g @angular/cli@18

      # Stage: Linting
      - name: Install ESLint
        run: ng add @angular-eslint/schematics --skip-confirmation

      - name: Run Linter
        run: ng lint

  sca:
    name: SCA with Snyk
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [22.x]

    steps:
      # Checkout Repository
      - name: Checkout Repository
        uses: actions/checkout@v3
        
      # Set up Node.js environment
      - name: Set up Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}

      # Stage: Install Snyk
      - name: Install Snyk
        run: npm install -g snyk

      - name: Authenticate Snyk
        run: snyk auth ${{ secrets.SNYK_TOKEN }}

      - name: Test configuration
        run: snyk test

      - name: Code analysis
        run: snyk code test

      - name: Transfer results
        run: snyk monitor
        
  test:
    name: Test der Angular App
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [22.x]
        python-version: [3.8]
    
    steps:
      # Checkout Repository
      - name: Checkout Repository
        uses: actions/checkout@v3
        
      # Set up Python environment
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v3
        with:
          node-version: ${{ matrix.python-version }}

      # Set up Node.js environment
      - name: Set up Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}

      # Stage: Install Robot Framework
      - name: Install Robot Framework
        run: pip install robotframework

      - name: Install Robot Framework browser libary
        run: pip install robotframework-browser

      # Stage: Init Robot Framework
      - name: Init Robot Framework
        run: rfbrowser init

      # Stage: Run Robot Framework tests
      - name: Run Robot Framework tests
        run: robot Test.robot

  build-multiarch-release:
    name: Erstellung des Docker Image
    runs-on: ubuntu-latest

    steps:
      # Checkout Repository
      - name: Checkout Repository
        uses: actions/checkout@v3

      # Stage: Prerequisits
      - name: Set IMAGE_TAG
        run: echo "IMAGE_TAG=or_tool:0.0.${{ github.event.number }}" >> $GITHUB_ENV
      - name: Authentication on AWS
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-central-1
      - name: Authentication on ECR Repo
        run: aws ecr get-login-password --region eu-central-1 | docker login --username ${{ secrets.DOCKER_ECR_USERNAME }} --password-stdin ${{ secrets.DOCKER_ECR_SECRET }}
      - name: Wait for Docker Deamon
        run: until docker info; do sleep 5 && echo "Waiting for docker deamon..." ; done;

      # Stage: Create Docker image
      - name: Docker build create
        run: docker buildx create --use
      - name: Docker build image
        run: docker buildx build --platform linux/arm64/v8,linux/amd64 --tag $IMAGE_TAG .

      # Stage: Tag the Docker image
      #- name: Tag the Docker image for ECR
      #  run: docker tag $IMAGE_TAG:latest ${{ secrets.ECR_HOST }}/programmierprojekt/angular-webpage:0.0.${{ github.event.number }}

      # Stage: Push to AWS ECR
      - name: Push Docker image to AWS ECR
        run: docker push ${{ secrets.ECR_HOST }}/programmierprojekt/angular-webpage:0.0.${{ github.event.number }}
